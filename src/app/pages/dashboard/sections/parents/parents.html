<div id="parent-content" role="tabpanel" aria-labelledby="parent-tab" class="role-content">
  <!-- Main Dashboard -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Panel: Child Selector + Summary -->
    <div class="bg-teal-50 p-6 rounded-2xl shadow-inner">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-teal-700 flex items-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-users mr-2"
          >
            <path d="M14 19a6 6 0 0 0-12 0" />
            <circle cx="8" cy="10" r="4" />
            <path d="M20 21v-2a4 4 0 0 0-4-4h-4" />
            <circle cx="16" cy="10" r="4" />
          </svg>
          Manage Children
        </h3>
        <button
          type="button"
          title="Add Child"
          (click)="openAddChildModal()"
          class="ml-3 px-3 py-2 bg-teal-600 text-white rounded-xl hover:bg-teal-700 shadow-sm"
        >
          +
        </button>
      </div>

      <!-- Child List -->
      <div class="space-y-2 max-h-96 overflow-y-auto pr-2">
        @for (child of children(); track child.id) {
        <button
          (click)="selectChild(child.id)"
          class="w-full text-left p-4 rounded-xl border-2 transition duration-200 ease-in-out flex justify-between items-center"
          [ngClass]="{
            'bg-white border-teal-500': selectedChildId() === child.id,
            'bg-teal-100 border-transparent': selectedChildId() !== child.id,
            'border-yellow-400 bg-yellow-50': child.status === 'pending'
          }"
        >
          <div class="flex-1">
            <p class="font-semibold text-teal-800 flex items-center gap-2">
              {{ child.full_name || child.name }}
            </p>
            <p class="text-sm text-gray-500">{{ child.gradeLevel }}</p>
          </div>
          <span
            class="text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap"
            [ngClass]="{
              'bg-red-100 text-red-700 border border-red-200': child.status === 'denied',
              'bg-teal-500 text-white': selectedChildId() === child.id && child.status !== 'denied',
              'bg-teal-200 text-teal-700':
                selectedChildId() !== child.id && child.status !== 'denied'
            }"
          >
            {{ child.status === 'denied' ? 'Denied' : (child.targets?.length || 0) + ' Goals' }}
          </span>
        </button>
        }
      </div>
    </div>

    <!-- Center Panel: Active Child Overview -->
    <div class="lg:col-span-2 bg-white border border-teal-200 p-6 rounded-2xl shadow-xl">
      @if (selectedChild(); as child) {

      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-teal-700 flex items-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-user mr-2"
          >
            <circle cx="12" cy="7" r="4" />
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
          </svg>
          {{ child.full_name || child.name }}'s Learning Summary
        </h3>

        <button
          class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center space-x-2"
          (click)="goToChildOptions()"
          title="Options"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-ellipsis"
          >
            <circle cx="12" cy="12" r="1" />
            <circle cx="19" cy="12" r="1" />
            <circle cx="5" cy="12" r="1" />
          </svg>
          <span>Options</span>
        </button>
      </div>

      @if (child.status === 'pending') {
      <div
        class="mb-6 p-4 rounded-xl border border-yellow-300 bg-yellow-50 flex flex-col md:flex-row md:items-center md:justify-between gap-3"
      >
        <div class="flex items-center gap-3">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-yellow-700 flex-shrink-0"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m5-3a8 8 0 11-16 0 8 8 0 0116 0z"
            />
          </svg>
          <p class="text-sm text-yellow-900 m-0">
            This child has requested access. Approve to link accounts, or deny to remove the
            request.
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button
            type="button"
            class="px-3 py-2 h-10 rounded-lg bg-teal-600 text-white hover:bg-teal-700"
            (click)="requestActionConfirmation('approve')"
          >
            Approve
          </button>
          <div class="relative">
            <button
              type="button"
              class="px-3 py-2 h-10 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 flex items-center justify-center"
              (click)="toggleActionMenu()"
              [attr.aria-expanded]="actionMenuOpen()"
              aria-haspopup="menu"
              title="More actions"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-x"
              >
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
              </svg>
            </button>
            @if (actionMenuOpen()) {
            <div
              class="absolute right-0 mt-2 w-36 bg-white border border-gray-200 rounded-lg shadow-lg z-30"
              role="menu"
            >
              <button
                type="button"
                class="w-full px-3 py-2 hover:bg-gray-50 flex items-center gap-2 text-left"
                (click)="requestActionConfirmation('deny')"
                role="menuitem"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-amber-700"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="m4.9 4.9 14.2 14.2" />
                </svg>
                Deny
              </button>
              <button
                type="button"
                class="w-full px-3 py-2 text-red-700 hover:bg-red-50 flex items-center gap-2 text-left"
                (click)="requestActionConfirmation('block')"
                role="menuitem"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-red-700"
                >
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z" />
                  <path d="m9.5 9.5 5 5" />
                  <path d="m14.5 9.5-5 5" />
                </svg>
                Block
              </button>
            </div>
            }
          </div>
        </div>
      </div>
      } @if (child.status === 'denied') {
      <div
        class="mb-6 p-4 rounded-xl border border-red-200 bg-red-50 text-red-800 flex items-center justify-between gap-3"
      >
        <p class="text-sm">
          This request was denied. You can still change your mind and approve later.
        </p>
        <button
          type="button"
          class="px-3 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700"
          (click)="requestActionConfirmation('approve')"
        >
          Approve
        </button>
      </div>
      }

      <!-- Stats Overview -->
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-teal-50 rounded-xl text-center">
          <p class="text-sm text-gray-500">Average Progress</p>
          <p class="text-2xl font-bold text-teal-700">{{ child.avgProgress }}%</p>
        </div>
        <div class="p-4 bg-teal-50 rounded-xl text-center">
          <p class="text-sm text-gray-500">Focus Areas</p>
          <div class="flex flex-wrap justify-center gap-2 mt-1">
            @for (item of child.focus; track item) {
            <span class="bg-teal-100 text-teal-700 text-sm px-3 py-1 rounded-full">{{ item }}</span>
            }
          </div>
        </div>
        <div class="p-4 bg-teal-50 rounded-xl text-center">
          <p class="text-sm text-gray-500">Mood Indicator</p>
          <p class="text-lg font-semibold text-gray-700">{{ child.mood }}</p>
        </div>
      </div>

      <!-- Learning Goals -->
      <h4 class="text-lg font-bold text-teal-700 mb-3">Current Learning Goals</h4>
      <div class="space-y-3">
        @for (goal of (child.targets || []); track goal.id) {
        <div
          class="p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center"
        >
          <p class="font-medium text-gray-800">{{ goal.topic }}</p>
          <div class="w-full md:w-1/3 flex items-center mt-2 md:mt-0">
            <div class="w-full bg-gray-200 h-2 rounded-full mr-2">
              <div class="h-2 rounded-full bg-teal-500" [style.width.%]="goal.progress"></div>
            </div>
            <span class="text-sm text-gray-600">{{ goal.progress }}%</span>
          </div>
        </div>
        }
      </div>

      <!-- Audit Log -->
      <h4 class="text-lg font-bold text-teal-700 mt-8 mb-3 flex items-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-clipboard-list mr-2"
        >
          <path d="M9 12h6" />
          <path d="M9 16h6" />
          <path d="M9 8h6" />
          <path d="M4 6h16v14H4z" />
          <path d="M9 4h6v2H9z" />
        </svg>
        Recent Activity
      </h4>
      <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 max-h-64 overflow-y-auto">
        @for (entry of auditTrail(); track entry.id) {
        <div class="py-3 border-b border-gray-100 last:border-0">
          <p class="text-sm text-gray-800">{{ entry.activity }}</p>
          <p class="text-xs text-gray-500">{{ entry.time }}</p>
        </div>
        }
      </div>

      } @else {
      <!-- No Child Selected -->
      <div
        class="text-center p-12 bg-teal-50 border border-teal-200 rounded-xl flex flex-col items-center justify-center"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="40"
          height="40"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-user-circle text-teal-400 mb-4"
        >
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="10" r="3" />
          <path d="M12 14a4 4 0 0 0 4 4H8a4 4 0 0 0 4-4Z" />
        </svg>
        <p class="text-lg font-semibold text-teal-700 mb-2">Select a Child</p>
        <p class="text-gray-500">
          Choose a child from the list to view their learning insights and audit trail.
        </p>
      </div>
      }
    </div>
  </div>
  @if (showAddChildModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-teal-700">Add Child</h3>
        <button
          type="button"
          class="text-gray-500 hover:text-gray-700"
          aria-label="Close"
          (click)="closeAddChildModal()"
        >
          X
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
          <input
            type="text"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
            [value]="newChild().full_name"
            (input)="onChildFieldChange('full_name', $any($event.target).value)"
            placeholder="e.g., Alex Johnson"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input
            type="email"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
            [value]="newChild().email"
            (input)="onChildFieldChange('email', $any($event.target).value)"
            placeholder="child@example.com"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Birthday</label>
          <input
            type="date"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
            [value]="newChild().birthday"
            (input)="onChildFieldChange('birthday', $any($event.target).value)"
          />
        </div>
      </div>
      <div class="mt-6 flex justify-end space-x-3">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
          (click)="closeAddChildModal()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700"
          (click)="saveChild()"
        >
          Save
        </button>
      </div>
    </div>
  </div>
  } @if (pendingAction(); as pending) {
  <div class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-2">
        Confirm
        {{ pending.type === 'approve' ? 'Approval' : pending.type === 'deny' ? 'Denial' : 'Block' }}
      </h3>
      <p class="text-sm text-gray-600 mb-4">
        Are you sure you want to
        {{ pending.type === 'approve' ? 'approve' : pending.type === 'deny' ? 'deny' : 'block' }}
        {{ pending.childName }}? A confirmation from a guardian is required before they can access
        this app.
      </p>
      <div class="mt-4 flex justify-end space-x-3">
        <button
          type="button"
          class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
          (click)="cancelPendingAction()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-4 py-2 rounded-lg text-white"
          [ngClass]="{
            'bg-teal-600 hover:bg-teal-700': pending.type === 'approve',
            'bg-amber-600 hover:bg-amber-700': pending.type === 'deny',
            'bg-red-600 hover:bg-red-700': pending.type === 'block'
          }"
          (click)="confirmPendingAction()"
        >
          {{ pending.type === 'approve' ? 'Approve' : pending.type === 'deny' ? 'Deny' : 'Block' }}
        </button>
      </div>
    </div>
  </div>
  }
</div>
