<section class="profile-page">
  <header class="profile-header">
    <div>
      <app-breadcrumb
        label="Account Settings"
        [disableDashboard]="isDashboardDisabled()"
        dashboardTooltip="Complete your profile to unlock the dashboard"
      ></app-breadcrumb>
      <h1>Profile</h1>
    </div>
  </header>

  <div class="grid gap-5 items-start lg:grid-cols-3">
    <div class="lg:col-span-2">
  <ng-container *ngIf="!profileLocked(); else lockedProfile">
    <ng-container *ngIf="profileComplete() && !editing(); else editFlow">
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <p class="eyebrow">Profile</p>
          <h2>{{ profile()?.full_name || 'Name not set' }}</h2>
          <p class="lede small">
            <app-masked-email [email]="profile()?.email || 'Email not set'"></app-masked-email>
          </p>
        </div>
        <button class="ghost" type="button" (click)="startEdit()" [disabled]="profileLocked()">Edit profile</button>
      </div>

      <div class="row">
        <div class="label">Birthday</div>
        <div class="value">{{ profile()?.birthday || '-' }}</div>
      </div>
      <div class="row">
        <div class="label">Grade</div>
        <div class="value">{{ profile()?.grade ? gradeLabel() : 'Not set' }}</div>
      </div>
      <div class="row" *ngIf="(age() ?? 0) >= 18">
        <div class="label">Roles</div>
        <div class="value">
          <span *ngIf="profile()?.is_guardian">Parent</span>
          <span *ngIf="profile()?.is_guardian && profile()?.is_teacher"> / </span>
          <span *ngIf="profile()?.is_teacher">Teacher</span>
          <span *ngIf="!profile()?.is_guardian && !profile()?.is_teacher">—</span>
        </div>
      </div>
    </div>
  </ng-container>

  </ng-container>

  <ng-template #editFlow>
    <div class="stepper">
      <div class="steps">
        <button
          class="step"
          type="button"
          [class.active]="currentStep() === 1"
          [disabled]="currentStep() === 1"
          (click)="goToStep(1)"
        >
          1. Basics
        </button>
        <button
          class="step"
          type="button"
          [class.active]="currentStep() === 2"
          [disabled]="currentStep() === 2 || saving() || !form().birthday"
          (click)="goToStep(2)"
        >
          2. Next steps
        </button>
      </div>

      <div class="step-card" *ngIf="currentStep() === 1">
        <p class="eyebrow">Step 1</p>
        <h2>Confirm your details</h2>
        <p class="hint">We pulled these from Google; please add your birthday to continue.</p>

        <div class="field">
          <label>Email</label>
          <input type="email" [ngModel]="form().email" readonly disabled />
        </div>

        <div class="field">
          <label>Full name</label>
          <input type="text" [ngModel]="form().full_name" readonly disabled />
        </div>

        <div class="field">
          <label>Birthday</label>
          <input type="date" [ngModel]="form().birthday" (ngModelChange)="updateBirthday($event)" />
        </div>
        <div class="field">
          <label>Grade (optional)</label>
          <select
            [ngModel]="form().grade"
            (ngModelChange)="updateGrade($event)"
          >
            <option value="">Select a grade</option>
            <option *ngFor="let option of gradeOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>
        <p class="hint">
          Athena's Learning Companion is designed for users under 18. Kids under 13 need a parent or
          guardian’s approval, while those 18+ can use the app as a parent and/or teacher.
        </p>

        <div class="actions">
          <button
            class="refresh"
            type="button"
            (click)="nextStep()"
            [disabled]="!form().birthday || saving()"
          >
            {{ saving() ? 'Saving...' : 'Save and continue' }}
          </button>
        </div>
      </div>

      <div class="step-card" *ngIf="currentStep() === 2">
        <p class="eyebrow">Step 2</p>
        <h2 *ngIf="ageBucket() === 'under13'">We need a parent to continue</h2>
        <h2 *ngIf="ageBucket() === 'adult'">How do you want to use Athena?</h2>

        <div *ngIf="ageBucket() === 'under13'" class="gate">
          <div class="gate-header">
            <span class="gate-icon">⚠️</span>
            <div>
              <p><strong>Under 13 requires a parent account.</strong></p>
              <p>To keep you safe, a parent or guardian needs to sign in and add you as a child.</p>
            </div>
          </div>
          <p class="hint">Please ask a parent to continue from their account.</p>
          <p class="hint">
            Enter your parent or guardian's email and we'll send them a link to get started.
          </p>
          <div class="field">
            <label>Parent or guardian email</label>
            <input
              type="email"
              placeholder="parent@example.com"
              [ngModel]="parentEmail()"
              (ngModelChange)="onParentEmailChange($event)"
              [class.error]="!!parentEmailError()"
              data-sitekey="6Lc2OiAsAAAAAHZXE64gzTrmdKvvxVMjqdxUa8O5"
            />
            <p class="error" *ngIf="parentEmailError()">{{ parentEmailError() }}</p>
          </div>
          <div class="actions">
            <button
              class="refresh"
              type="button"
              (click)="sendParentInvite()"
              [disabled]="sendingInvite() || !!parentEmailError() || !parentEmail()"
            >
              {{ sendingInvite() ? 'Sending...' : 'Send invite' }}
            </button>
            <p class="hint success" *ngIf="inviteMessage()">{{ inviteMessage() }}</p>
          </div>
          <div id="recaptcha-container" hidden data-sitekey="6Lc2OiAsAAAAAHZXE64gzTrmdKvvxVMjqdxUa8O5"></div>
        </div>

        <div *ngIf="ageBucket() === 'adult'" class="selector">
          <p class="hint">Select all that apply:</p>
          <label class="chip">
            <input type="checkbox" [checked]="form().is_guardian" (change)="toggleRole('parent')" />
            <span>Parent</span>
          </label>
          <label class="chip">
            <input type="checkbox" [checked]="form().is_teacher" (change)="toggleRole('teacher')" />
            <span>Teacher</span>
          </label>
          <p class="hint">You can choose one or both.</p>
          <div class="actions">
            <button
              class="refresh"
              type="button"
              (click)="goToDashboard()"
              [disabled]="!canContinueAdult()"
            >
              Save and continue
            </button>
          </div>
        </div>

        <div *ngIf="ageBucket() === 'unknown'" class="gate">
          <p>We need your birthday to determine the right experience.</p>
          <button class="ghost" type="button" (click)="currentStep.set(1)">Back to birthday</button>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #lockedProfile>
    <div class="summary-card">
      <div class="summary-header">
        <div>
          <p class="eyebrow">Profile locked</p>
          <h2>{{ profile()?.full_name || profile()?.email || 'Profile' }}</h2>
          <p class="lede small">A parent or guardian has disabled editing for this profile.</p>
        </div>
      </div>
      <div class="row">
        <div class="label">Email</div>
        <div class="value">
          <app-masked-email [email]="profile()?.email || 'Email not set'"></app-masked-email>
        </div>
      </div>
      <div class="row">
        <div class="label">Birthday</div>
        <div class="value">{{ profile()?.birthday || 'Birthday not set' }}</div>
      </div>
      <div class="row">
        <div class="label">Grade</div>
        <div class="value">{{ profile()?.grade ? gradeLabel() : 'Not set' }}</div>
      </div>
    </div>
  </ng-template>

    </div>

  <section
    class="card blocklist-card lg:mt-0"
    *ngIf="ageBucket() === 'adult'; else guardiansCard"
  >
    <div class="blocklist-header">
      <div>
        <p class="eyebrow">Blocked requests</p>
        <p class="hint">Children you blocked will not be able to request access again.</p>
      </div>
    </div>

    <ng-container *ngIf="blocklistLoading(); else blocklistContent">
      <p class="hint">Loading blocked requests...</p>
    </ng-container>
    <ng-template #blocklistContent>
      <div *ngIf="blocklist().length; else emptyBlocklist" class="blocklist-list">
        <div class="blocked-row" *ngFor="let blocked of blocklist()">
          <div class="blocked-meta">
            <p class="blocked-name">{{ blocked.full_name || 'Unknown child' }}</p>
            <p class="blocked-email">{{ blocked.email || 'Email unavailable' }}</p>
            <p class="blocked-date" [title]="formatBlockedTimestamp(blocked.blocked_at)">
              Blocked {{ formatBlockedRelative(blocked.blocked_at) }}
            </p>
          </div>
          <div class="blocked-actions">
              <button
                class="ghost"
                type="button"
                (click)="unblockChild(blocked.child_profile_id, false, blocked.full_name)"
                [disabled]="blocklistAction()"
              >
                Unblock
              </button>
              <button
                class="refresh"
                type="button"
                (click)="unblockChild(blocked.child_profile_id, true, blocked.full_name)"
                [disabled]="blocklistAction()"
              >
                Unblock & add child
              </button>
          </div>
        </div>
      </div>
      <ng-template #emptyBlocklist>
        <div class="empty">
          <p class="blocked-name">No blocked requests</p>
          <p class="hint">When you block a request, it will appear here with an option to undo.</p>
        </div>
      </ng-template>
    </ng-template>
  </section>
  <ng-template #guardiansCard>
    <section class="card blocklist-card lg:mt-0">
      <div class="blocklist-header">
        <div>
          <p class="eyebrow">Parents / Guardians</p>
          <p class="hint">People linked to your account as guardians.</p>
        </div>
      </div>

      <ng-container *ngIf="guardiansLoading(); else guardiansContent">
        <p class="hint">Loading parents/guardians...</p>
      </ng-container>
      <ng-template #guardiansContent>
        <div *ngIf="guardians().length; else emptyGuardians" class="blocklist-list">
          <div class="blocked-row" *ngFor="let guardian of guardians()">
            <div class="blocked-meta">
              <p class="blocked-name">{{ guardian.full_name || 'Guardian' }}</p>
              <p class="blocked-email">{{ guardian.email || 'Email unavailable' }}</p>
              <p
                class="blocked-date"
                [title]="formatBlockedTimestamp(guardian.approved_at || guardian.invited_at)"
              >
                Linked {{ formatBlockedRelative(guardian.approved_at || guardian.invited_at) }}
              </p>
            </div>
          </div>
        </div>
        <ng-template #emptyGuardians>
          <div class="empty">
            <p class="blocked-name">No parents or guardians linked</p>
            <p class="hint">Ask a parent or guardian to connect to your account.</p>
          </div>
        </ng-template>
      </ng-template>
    </section>
  </ng-template>
  </div>
</section>
