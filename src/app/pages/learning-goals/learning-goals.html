<div class="max-w-6xl mx-auto p-6 space-y-6">
  <app-breadcrumb
    [labels]="breadcrumbLabels()"
    [showDashboardCrumb]="true"
    [disableDashboard]="false"
  />

  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-teal-700">{{ childName() }}'s Learning Goals</h1>
    </div>
    <div></div>
  </div>
  <div class="flex flex-wrap items-center gap-3 justify-end relative">
    <input
      type="search"
      class="border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-200"
      placeholder="Search goals"
      [value]="search()"
      (input)="search.set($any($event.target).value)"
    />
    <button
      type="button"
      class="px-3 py-2 rounded-lg bg-teal-600 text-white text-sm font-semibold hover:bg-teal-700 disabled:opacity-60"
      (click)="openAddModal()"
      [disabled]="saving() || loading()"
    >
      Add Goals
    </button>
    <div class="relative">
      <button
        type="button"
        class="h-10 w-10 inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50"
        (click)="toggleFiltersMenu()"
        aria-label="Filters menu"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H10a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V10c0 .69.4 1.3 1.02 1.58.19.09.41.14.63.14H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z" />
        </svg>
      </button>
      <div
        class="absolute right-0 mt-2 w-72 bg-white border border-slate-200 rounded-xl shadow-lg p-4 z-10 space-y-3"
        *ngIf="filtersMenuOpen()"
      >
        <label class="inline-flex items-center gap-2 text-sm text-slate-700">
          <input
            type="checkbox"
            class="h-4 w-4 rounded border-slate-300 text-teal-600"
            [checked]="activeOnly()"
            (change)="toggleActiveOnly($any($event.target).checked)"
          />
          Active Only (hide completed/removed)
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-slate-700">
          <input
            type="checkbox"
            class="h-4 w-4 rounded border-slate-300 text-teal-600"
            [checked]="showDetails()"
            (change)="showDetails.set($any($event.target).checked)"
          />
          Show details (created/updated/email)
        </label>
        <div class="flex justify-end">
          <button
            type="button"
            class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm"
            (click)="closeFiltersMenu()"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    @if (loading()) {
    <div class="p-6 space-y-3 animate-pulse">
      <div class="h-6 w-1/3 bg-slate-100 rounded"></div>
      <div class="h-4 w-1/4 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
    </div>
    } @else if ((displayGoals() || []).length === 0) {
    <div class="p-8 text-center space-y-3">
      <h2 class="text-lg font-semibold text-slate-700">No learning goals yet</h2>
      <p class="text-sm text-slate-500">
        When goals are created for this learner, you'll see them listed here with progress and
        status.
      </p>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-4 py-3 text-left font-semibold">
              <button class="flex items-center gap-1" (click)="setSort('topic')">
                Goal
                <span class="text-xs text-slate-400" *ngIf="sortField() === 'topic'">
                  {{ sortDir() === 'asc' ? '▲' : '▼' }}
                </span>
              </button>
            </th>
            <th class="px-4 py-3 text-left font-semibold">
              <button class="flex items-center gap-1" (click)="setSort('progress')">
                Progress
                <span class="text-xs text-slate-400" *ngIf="sortField() === 'progress'">
                  {{ sortDir() === 'asc' ? '▲' : '▼' }}
                </span>
              </button>
            </th>
            <th class="px-4 py-3 text-left font-semibold">
              <button class="flex items-center gap-1" (click)="setSort('status')">
                Status
                <span class="text-xs text-slate-400" *ngIf="sortField() === 'status'">
                  {{ sortDir() === 'asc' ? '▲' : '▼' }}
                </span>
              </button>
            </th>
            <th class="px-4 py-3 text-left font-semibold">
              <button class="flex items-center gap-1" (click)="setSort('created_by')">
                Added By
                <span class="text-xs text-slate-400" *ngIf="sortField() === 'created_by'">
                  {{ sortDir() === 'asc' ? '▲' : '▼' }}
                </span>
              </button>
            </th>
            <th class="px-4 py-3 text-left font-semibold" *ngIf="showDetails()">
              Created
            </th>
            <th class="px-4 py-3 text-left font-semibold" *ngIf="showDetails()">
              <button class="flex items-center gap-1" (click)="setSort('updated_at')">
                Updated
                <span class="text-xs text-slate-400" *ngIf="sortField() === 'updated_at'">
                  {{ sortDir() === 'asc' ? '▲' : '▼' }}
                </span>
              </button>
            </th>
            <th class="px-4 py-3 text-left font-semibold" *ngIf="showDetails()">
              Added By Email
            </th>
            <th class="px-4 py-3 text-right font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          @for (goal of displayGoals(); track goal.id) {
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 font-medium text-slate-800">{{ goal.topic }}</td>
            <td class="px-4 py-3 text-slate-700">
              <div class="flex items-center gap-3">
                <div class="w-32 bg-slate-200 h-2 rounded-full overflow-hidden">
                  <div class="h-2 bg-teal-500 rounded-full" [style.width.%]="goal.progress"></div>
                </div>
                <span class="font-semibold">{{ goal.progress }}%</span>
              </div>
            </td>
            <td class="px-4 py-3">
              <span
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
                [ngClass]="{
                  'bg-emerald-50 text-emerald-700': (goal.status || 'active') === 'active',
                  'bg-amber-50 text-amber-700': (goal.status || '').toLowerCase() === 'paused',
                  'bg-slate-100 text-slate-700': (goal.status || '').toLowerCase() === 'completed'
                }"
              >
                {{ goal.status || 'active' }}
              </span>
            </td>
            <td class="px-4 py-3 text-slate-700 capitalize">
              {{ goal.created_by || 'parent' }}
            </td>
            <td class="px-4 py-3 text-slate-600" *ngIf="showDetails()">
              {{ formattedDate(goal.created_at) }}
            </td>
            <td class="px-4 py-3 text-slate-600" *ngIf="showDetails()">
              {{ formattedDate(goal.updated_at || goal.created_at) }}
            </td>
            <td class="px-4 py-3 text-slate-700" *ngIf="showDetails()">
              {{ goal.created_by_email || '—' }}
            </td>
            <td class="px-4 py-3 text-right">
              <button
                type="button"
                class="text-red-600 hover:text-red-700 text-sm font-semibold"
                (click)="deleteGoal(goal.id)"
              >
                Remove
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3 text-sm" *ngIf="total() > 0">
    <div class="text-slate-600">
      Showing
      <strong>{{ rangeStart() }}</strong>
      -
      <strong>{{ rangeEnd() }}</strong>
      of <strong>{{ total() }}</strong>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-1">
        <button
          type="button"
          class="px-3 py-2 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50"
          (click)="goToPage(page() - 1)"
          [disabled]="page() <= 1"
        >
          Previous
        </button>
        <button
          type="button"
          class="px-3 py-2 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50"
          (click)="goToPage(page() + 1)"
          [disabled]="page() >= totalPages()"
        >
          Next
        </button>
      </div>
      <span class="text-slate-500">Page {{ page() }} of {{ totalPages() }}</span>
      <label class="flex items-center gap-2 text-slate-600">
        Per page
        <select
          class="border border-slate-200 rounded-lg px-2 py-1"
          [value]="pageSize()"
          (change)="changePageSize($any($event.target).value)"
        >
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
      </label>
    </div>
  </div>
</div>

<!-- Confirm Remove Modal -->
<div
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4"
  *ngIf="confirmDeleteState()"
>
  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
    <div class="flex items-start gap-3">
      <div class="h-10 w-10 flex items-center justify-center rounded-full bg-amber-50 text-amber-700">
        !
      </div>
      <div>
        <h3 class="text-lg font-bold text-slate-800">Confirm removal</h3>
        <p class="text-sm text-slate-600 m-0">{{ confirmDeleteState()?.message }}</p>
      </div>
    </div>
    <div class="flex justify-end gap-3">
      <button
        type="button"
        class="px-4 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50"
        (click)="cancelDelete()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700"
        (click)="confirmDelete()"
      >
        Remove goal
      </button>
    </div>
  </div>
</div>

<!-- Add Goals Modal -->
<div
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-40 p-4"
  *ngIf="showAddModal()"
>
  <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Add Goals</p>
        <h2 class="text-lg font-bold text-slate-800">Browse catalog</h2>
      </div>
      <button
        type="button"
        class="h-8 w-8 inline-flex items-center justify-center rounded-lg border border-slate-200 hover:bg-slate-100"
        (click)="closeAddModal()"
        aria-label="Close"
      >
        ✕
      </button>
    </div>
    <div class="p-5 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label class="flex flex-col text-sm text-slate-700">
          Age Range
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterAge()"
            (change)="filterAge.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="8-10">8-10</option>
            <option value="10-12">10-12</option>
            <option value="12-14">12-14</option>
          </select>
        </label>
        <label class="flex flex-col text-sm text-slate-700">
          Grade
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterGrade()"
            (change)="filterGrade.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="3-4">3-4</option>
            <option value="5-6">5-6</option>
            <option value="7-8">7-8</option>
          </select>
        </label>
        <label class="flex flex-col text-sm text-slate-700">
          Subject
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterSubject()"
            (change)="filterSubject.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="Math">Math</option>
            <option value="Science">Science</option>
            <option value="History">History</option>
            <option value="Language Arts">Language Arts</option>
          </select>
        </label>
      </div>
      <div class="border border-slate-200 rounded-xl overflow-hidden">
        <table class="min-w-full text-sm divide-y divide-slate-200">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-2 text-left font-semibold w-10">Pick</th>
              <th class="px-4 py-2 text-left font-semibold">Goal</th>
              <th class="px-4 py-2 text-left font-semibold">Age</th>
              <th class="px-4 py-2 text-left font-semibold">Grade</th>
              <th class="px-4 py-2 text-left font-semibold">Subject</th>
              <th class="px-4 py-2 text-right font-semibold">Added</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            @for (item of filteredCatalog(); track item.id) {
            <tr>
              <td class="px-4 py-2">
                <input
                  type="checkbox"
                  class="h-4 w-4 rounded border-slate-300 text-teal-600"
                  [checked]="catalogSelections()[item.id]"
                  (change)="toggleCatalogSelection(item.id, $any($event.target).checked)"
                />
              </td>
              <td class="px-4 py-2 font-medium text-slate-800">{{ item.topic }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.age }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.grade }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.subject }}</td>
              <td class="px-4 py-2 text-right">
                <span
                  *ngIf="catalogSelections()[item.id]"
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700"
                >
                  Selected
                </span>
              </td>
            </tr>
            }
            @if (filteredCatalog().length === 0) {
            <tr>
              <td colspan="5" class="px-4 py-4 text-center text-slate-500">No goals match these filters.</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    <div class="px-5 py-4 border-t border-slate-200 flex justify-between items-center">
      <span class="text-sm text-slate-600">
        Selected {{ selectedCatalogCount() }} goal(s)
      </span>
      <button
        type="button"
        class="px-3 py-2 rounded-lg bg-teal-600 text-white text-sm font-semibold hover:bg-teal-700 disabled:opacity-60"
        (click)="addSelectedCatalogGoals()"
        [disabled]="saving()"
      >
        Add Selected
      </button>
      <button
        type="button"
        class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50"
        (click)="closeAddModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>


