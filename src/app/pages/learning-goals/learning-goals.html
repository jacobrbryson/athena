<div class="max-w-6xl mx-auto p-6 space-y-6">
  <app-breadcrumb
    [labels]="breadcrumbLabels()"
    [showDashboardCrumb]="true"
    [disableDashboard]="false"
  />

  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-teal-700">{{ childName() }}'s Learning Goals</h1>
    </div>
    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm text-slate-700">
        <input
          type="checkbox"
          class="h-4 w-4 rounded border-slate-300 text-teal-600"
          [checked]="activeOnly()"
          (change)="toggleActiveOnly($any($event.target).checked)"
        />
        Active Only (hide completed/removed)
      </label>
      <button
        type="button"
        class="px-3 py-2 rounded-lg bg-teal-600 text-white text-sm font-semibold hover:bg-teal-700 disabled:opacity-60"
        (click)="openAddModal()"
        [disabled]="saving() || loading()"
      >
        Add Goals
      </button>
    </div>
  </div>

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    @if (loading()) {
    <div class="p-6 space-y-3 animate-pulse">
      <div class="h-6 w-1/3 bg-slate-100 rounded"></div>
      <div class="h-4 w-1/4 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
      <div class="h-10 bg-slate-100 rounded"></div>
    </div>
    } @else if ((goals() || []).length === 0) {
    <div class="p-8 text-center space-y-3">
      <h2 class="text-lg font-semibold text-slate-700">No learning goals yet</h2>
      <p class="text-sm text-slate-500">
        When goals are created for this learner, you'll see them listed here with progress and
        status.
      </p>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-4 py-3 text-left font-semibold">Goal</th>
            <th class="px-4 py-3 text-left font-semibold">Progress</th>
            <th class="px-4 py-3 text-left font-semibold">Status</th>
            <th class="px-4 py-3 text-left font-semibold">Added By</th>
            <th class="px-4 py-3 text-left font-semibold">Updated</th>
            <th class="px-4 py-3 text-right font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          @for (goal of goals(); track goal.id) {
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 font-medium text-slate-800">{{ goal.topic }}</td>
            <td class="px-4 py-3 text-slate-700">
              <div class="flex items-center gap-3">
                <div class="w-32 bg-slate-200 h-2 rounded-full overflow-hidden">
                  <div class="h-2 bg-teal-500 rounded-full" [style.width.%]="goal.progress"></div>
                </div>
                <span class="font-semibold">{{ goal.progress }}%</span>
              </div>
            </td>
            <td class="px-4 py-3">
              <span
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
                [ngClass]="{
                  'bg-emerald-50 text-emerald-700': (goal.status || 'active') === 'active',
                  'bg-amber-50 text-amber-700': (goal.status || '').toLowerCase() === 'paused',
                  'bg-slate-100 text-slate-700': (goal.status || '').toLowerCase() === 'completed'
                }"
              >
                {{ goal.status || 'active' }}
              </span>
            </td>
            <td class="px-4 py-3 text-slate-700 capitalize">
              {{ goal.created_by || 'parent' }}
            </td>
            <td class="px-4 py-3 text-slate-600">
              {{ formattedDate(goal.updated_at || goal.created_at) }}
            </td>
            <td class="px-4 py-3 text-right">
              <button
                type="button"
                class="text-red-600 hover:text-red-700 text-sm font-semibold"
                (click)="deleteGoal(goal.id)"
              >
                Remove
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3 text-sm" *ngIf="total() > 0">
    <div class="text-slate-600">
      Showing
      <strong>{{ rangeStart() }}</strong>
      -
      <strong>{{ rangeEnd() }}</strong>
      of <strong>{{ total() }}</strong>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-1">
        <button
          type="button"
          class="px-3 py-2 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50"
          (click)="goToPage(page() - 1)"
          [disabled]="page() <= 1"
        >
          Previous
        </button>
        <button
          type="button"
          class="px-3 py-2 rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50"
          (click)="goToPage(page() + 1)"
          [disabled]="page() >= totalPages()"
        >
          Next
        </button>
      </div>
      <span class="text-slate-500">Page {{ page() }} of {{ totalPages() }}</span>
      <label class="flex items-center gap-2 text-slate-600">
        Per page
        <select
          class="border border-slate-200 rounded-lg px-2 py-1"
          [value]="pageSize()"
          (change)="changePageSize($any($event.target).value)"
        >
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
        </select>
      </label>
    </div>
  </div>
</div>

<!-- Add Goals Modal -->
<div
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-40 p-4"
  *ngIf="showAddModal()"
>
  <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Add Goals</p>
        <h2 class="text-lg font-bold text-slate-800">Browse catalog</h2>
      </div>
      <button
        type="button"
        class="h-8 w-8 inline-flex items-center justify-center rounded-lg border border-slate-200 hover:bg-slate-100"
        (click)="closeAddModal()"
        aria-label="Close"
      >
        âœ•
      </button>
    </div>
    <div class="p-5 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label class="flex flex-col text-sm text-slate-700">
          Age Range
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterAge()"
            (change)="filterAge.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="8-10">8-10</option>
            <option value="10-12">10-12</option>
            <option value="12-14">12-14</option>
          </select>
        </label>
        <label class="flex flex-col text-sm text-slate-700">
          Grade
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterGrade()"
            (change)="filterGrade.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="3-4">3-4</option>
            <option value="5-6">5-6</option>
            <option value="7-8">7-8</option>
          </select>
        </label>
        <label class="flex flex-col text-sm text-slate-700">
          Subject
          <select
            class="mt-1 border border-slate-200 rounded-lg px-3 py-2"
            [value]="filterSubject()"
            (change)="filterSubject.set($any($event.target).value)"
          >
            <option value="all">All</option>
            <option value="Math">Math</option>
            <option value="Science">Science</option>
            <option value="History">History</option>
            <option value="Language Arts">Language Arts</option>
          </select>
        </label>
      </div>
      <div class="border border-slate-200 rounded-xl overflow-hidden">
        <table class="min-w-full text-sm divide-y divide-slate-200">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-2 text-left font-semibold">Goal</th>
              <th class="px-4 py-2 text-left font-semibold">Age</th>
              <th class="px-4 py-2 text-left font-semibold">Grade</th>
              <th class="px-4 py-2 text-left font-semibold">Subject</th>
              <th class="px-4 py-2 text-right font-semibold">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            @for (item of filteredCatalog(); track item.id) {
            <tr>
              <td class="px-4 py-2 font-medium text-slate-800">{{ item.topic }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.age }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.grade }}</td>
              <td class="px-4 py-2 text-slate-600">{{ item.subject }}</td>
              <td class="px-4 py-2 text-right">
                <button
                  type="button"
                  class="px-3 py-1.5 rounded-lg bg-teal-600 text-white text-xs font-semibold hover:bg-teal-700 disabled:opacity-60"
                  (click)="addCatalogGoal(item.topic)"
                  [disabled]="saving()"
                >
                  Add
                </button>
              </td>
            </tr>
            }
            @if (filteredCatalog().length === 0) {
            <tr>
              <td colspan="5" class="px-4 py-4 text-center text-slate-500">No goals match these filters.</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    <div class="px-5 py-4 border-t border-slate-200 flex justify-end">
      <button
        type="button"
        class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50"
        (click)="closeAddModal()"
      >
        Close
      </button>
    </div>
  </div>
</div>
